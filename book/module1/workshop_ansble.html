<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Workshop Ansible</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../devopt_introduction.html"><strong aria-hidden="true">1.</strong> แนวคิด DevOps</a></li><li class="chapter-item expanded "><a href="../cicd.html"><strong aria-hidden="true">2.</strong> แนวคิด CI/CD</a></li><li class="chapter-item expanded "><a href="../prepareration/setup_vagrant.html"><strong aria-hidden="true">3.</strong> Setup Vagrant</a></li><li class="chapter-item expanded "><a href="../prepareration/vagrant_workshop.html"><strong aria-hidden="true">4.</strong> vagrant workshop: LAMP Stack</a></li><li class="chapter-item expanded "><a href="../prepareration/vagrant_docker.html"><strong aria-hidden="true">5.</strong> vagrant workshop: Docker host</a></li><li class="chapter-item expanded "><a href="../module1/ansible_introduction.html"><strong aria-hidden="true">6.</strong> แนะนำ Ansible</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../module1/ssh_key.html"><strong aria-hidden="true">6.1.</strong> การสร้าง ssh-key</a></li><li class="chapter-item expanded "><a href="../module1/yaml_basic.html"><strong aria-hidden="true">6.2.</strong> การใช้งาน yaml</a></li></ol></li><li class="chapter-item expanded "><a href="../module1/workshop_ansble.html" class="active"><strong aria-hidden="true">7.</strong> Workshop Ansible</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="workshop-ansible"><a class="header" href="#workshop-ansible">Workshop Ansible</a></h1>
<h2 id="ขันตอนการสราง-single-node-lamp-stack-ดวย-vagrant"><a class="header" href="#ขันตอนการสราง-single-node-lamp-stack-ดวย-vagrant">ขั้นตอนการสร้าง Single Node LAMP Stack ด้วย Vagrant</a></h2>
<h3 id="1-การตังคาโปรเจค"><a class="header" href="#1-การตังคาโปรเจค">1. การตั้งค่าโปรเจค</a></h3>
<ol>
<li>
<p>เปิดเทอร์มินัลหรือ PowerShell</p>
</li>
<li>
<p>สร้างไดเรกทอรีใหม่สำหรับโปรเจค</p>
<pre><code class="language-sh">mkdir vagrant-ansible
cd vagrant-ansible
</code></pre>
</li>
<li>
<p>สร้าง Vagrantfile  <code>code Vagrantfile</code></p>
</li>
</ol>
<pre><code class="language-ruby"># -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.

$script=&lt;&lt;-SCRIPT
     sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config    
     systemctl restart sshd.service
     #sudo dnf install -y epel-release
     #sudo dnf install -y ansible
SCRIPT

Vagrant.configure("2") do |config|

  config.vm.box = "generic/centos9s"

  config.vm.network "private_network", ip: "192.168.33.20"
  #config.vm.network "public_network"
  config.vm.synced_folder ".", "/vagrant"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end

  config.vm.provision "shell", inline: $script
end

</code></pre>
<p>Run:</p>
<pre><code class="language-sh">vagrant up
</code></pre>
<p>Login ด้วย คำสั่ง vagrant</p>
<pre><code>vagrant ssh
</code></pre>
<p>หรือ ใช้คำสั่ง ssh</p>
<pre><code>ssh vagrant@192.168.33.20
</code></pre>
<p>ติดตั้ง Ansible แบบ manual</p>
<pre><code>[vagrant@centos9s ~]$ sudo dnf install -y epel-release
[vagrant@centos9s ~]$ sudo dnf install -y ansible
Last metadata expiration check: 0:00:48 ago on Thu 01 Aug 2024 01:27:45 PM UTC.
Dependencies resolved.
========================================================================================================
 Package                        Architecture     Version                      Repository           Size
========================================================================================================
Installing:
 ansible                        noarch           1:7.7.0-1.el9                epel                 34 M
Installing dependencies:
 ansible-core                   x86_64           1:2.14.17-1.el9              appstream           2.6 M
 git-core                       x86_64           2.43.5-1.el9                 appstream           4.4 M
 python3-cffi                   x86_64           1.14.5-5.el9                 baseos              253 k
 python3-cryptography           x86_64           36.0.1-4.el9                 baseos              1.2 M
 python3-packaging              noarch           20.9-5.el9                   appstream            77 k
 python3-ply                    noarch           3.11-14.el9                  baseos              106 k
 python3-pycparser              noarch           2.20-6.el9                   baseos              135 k
 python3-pyyaml                 x86_64           5.4.1-6.el9                  baseos              205 k
 python3-resolvelib             noarch           0.5.4-5.el9                  appstream            34 k
 python3-setuptools             noarch           53.0.0-13.el9                baseos              943 k
 sshpass                        x86_64           1.09-4.el9                   appstream            28 k

Transaction Summary
========================================================================================================
Install  12 Packages

Total download size: 44 M
Installed size: 407 M
Is this ok [y/N]: y
Downloading Packages:
(1/12): python3-ply-3.11-14.el9.noarch.rpm                              141 kB/s | 106 kB     00:00
(2/12): python3-cffi-1.14.5-5.el9.x86_64.rpm                            268 kB/s | 253 kB     00:00
(3/12): python3-pyyaml-5.4.1-6.el9.x86_64.rpm                           825 kB/s | 205 kB     00:00
(4/12): python3-pycparser-2.20-6.el9.noarch.rpm                         117 kB/s | 135 kB     00:01
(5/12): python3-cryptography-36.0.1-4.el9.x86_64.rpm                    530 kB/s | 1.2 MB     00:02
(6/12): python3-setuptools-53.0.0-13.el9.noarch.rpm                     680 kB/s | 943 kB     00:01
(7/12): python3-packaging-20.9-5.el9.noarch.rpm                         145 kB/s |  77 kB     00:00
(8/12): python3-resolvelib-0.5.4-5.el9.noarch.rpm                       237 kB/s |  34 kB     00:00
(9/12): sshpass-1.09-4.el9.x86_64.rpm                                   217 kB/s |  28 kB     00:00
(10/12): ansible-core-2.14.17-1.el9.x86_64.rpm                          1.6 MB/s | 2.6 MB     00:01
(11/12): git-core-2.43.5-1.el9.x86_64.rpm                               1.5 MB/s | 4.4 MB     00:02
(12/12): ansible-7.7.0-1.el9.noarch.rpm                                 4.6 MB/s |  34 MB     00:07
--------------------------------------------------------------------------------------------------------
Total                                                                   2.9 MB/s |  44 MB     00:15
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                                                1/1
  Installing       : sshpass-1.09-4.el9.x86_64                                                     1/12
  Installing       : python3-resolvelib-0.5.4-5.el9.noarch                                         2/12
  Installing       : python3-packaging-20.9-5.el9.noarch                                           3/12
  Installing       : git-core-2.43.5-1.el9.x86_64                                                  4/12
  Installing       : python3-setuptools-53.0.0-13.el9.noarch                                       5/12
  Installing       : python3-pyyaml-5.4.1-6.el9.x86_64                                             6/12
  Installing       : python3-ply-3.11-14.el9.noarch                                                7/12
  Installing       : python3-pycparser-2.20-6.el9.noarch                                           8/12
  Installing       : python3-cffi-1.14.5-5.el9.x86_64                                              9/12
  Installing       : python3-cryptography-36.0.1-4.el9.x86_64                                     10/12
  Installing       : ansible-core-1:2.14.17-1.el9.x86_64                                          11/12
  Installing       : ansible-1:7.7.0-1.el9.noarch                                                 12/12
  Running scriptlet: ansible-1:7.7.0-1.el9.noarch                                                 12/12
  Verifying        : python3-cffi-1.14.5-5.el9.x86_64                                              1/12
  Verifying        : python3-cryptography-36.0.1-4.el9.x86_64                                      2/12
  Verifying        : python3-ply-3.11-14.el9.noarch                                                3/12
  Verifying        : python3-pycparser-2.20-6.el9.noarch                                           4/12
  Verifying        : python3-pyyaml-5.4.1-6.el9.x86_64                                             5/12
  Verifying        : python3-setuptools-53.0.0-13.el9.noarch                                       6/12
  Verifying        : ansible-core-1:2.14.17-1.el9.x86_64                                           7/12
  Verifying        : git-core-2.43.5-1.el9.x86_64                                                  8/12
  Verifying        : python3-packaging-20.9-5.el9.noarch                                           9/12
  Verifying        : python3-resolvelib-0.5.4-5.el9.noarch                                        10/12
  Verifying        : sshpass-1.09-4.el9.x86_64                                                    11/12
  Verifying        : ansible-1:7.7.0-1.el9.noarch                                                 12/12

Installed:
  ansible-1:7.7.0-1.el9.noarch                         ansible-core-1:2.14.17-1.el9.x86_64
  git-core-2.43.5-1.el9.x86_64                         python3-cffi-1.14.5-5.el9.x86_64
  python3-cryptography-36.0.1-4.el9.x86_64             python3-packaging-20.9-5.el9.noarch
  python3-ply-3.11-14.el9.noarch                       python3-pycparser-2.20-6.el9.noarch
  python3-pyyaml-5.4.1-6.el9.x86_64                    python3-resolvelib-0.5.4-5.el9.noarch
  python3-setuptools-53.0.0-13.el9.noarch              sshpass-1.09-4.el9.x86_64

Complete!
</code></pre>
<pre><code>[vagrant@centos9s ~]$ sudo dnf info ansible
Extra Packages for Enterprise Linux 9 - x86_64                          3.4 kB/s | 4.6 kB     00:01
Installed Packages
Name         : ansible
Epoch        : 1
Version      : 7.7.0
Release      : 1.el9
Architecture : noarch
Size         : 365 M
Source       : ansible-7.7.0-1.el9.src.rpm
Repository   : @System
From repo    : epel
Summary      : Curated set of Ansible collections included in addition to ansible-core
URL          : https://ansible.com
License      : GPL-3.0-or-later AND Apache-2.0 AND BSD-2-Clause AND BSD-3-Clause AND MIT AND MPL-2.0 AND
             : PSF-2.0
Description  : Ansible is a radically simple model-driven configuration management,
             : multi-node deployment, and remote task execution system. Ansible works
             : over SSH and does not require any software or daemons to be installed
             : on remote nodes. Extension modules can be written in any language and
             : are transferred to managed machines automatically.
             :
             : This package provides a curated set of Ansible collections included in addition
             : to ansible-core.
</code></pre>
<pre><code>[vagrant@centos9s ~]$ sudo dnf info ansible-core
Extra Packages for Enterprise Linux 9 - Next - x86_64                    11 kB/s |  17 kB     00:01
Installed Packages
Name         : ansible-core
Epoch        : 1
Version      : 2.14.17
Release      : 1.el9
Architecture : x86_64
Size         : 10 M
Source       : ansible-core-2.14.17-1.el9.src.rpm
Repository   : @System
From repo    : appstream
Summary      : SSH-based configuration management, deployment, and task execution system
URL          : http://ansible.com
License      : GPLv3+
Description  : Ansible is a radically simple model-driven configuration management,
             : multi-node deployment, and remote task execution system. Ansible works
             : over SSH and does not require any software or daemons to be installed
             : on remote nodes. Extension modules can be written in any language and
             : are transferred to managed machines automatically.
</code></pre>
<p>Run คำสั่งเพื่อ อ่าน คู่มือการใช้</p>
<pre><code>man ansible
</code></pre>
<p><img src="../assets/images/ansible_man.png" alt="" /></p>
<p>Run คำสั่ง</p>
<pre><code>[vagrant@centos9s ~]$ ansible --version
ansible [core 2.14.17]
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/home/vagrant/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.9/site-packages/ansible
  ansible collection location = /home/vagrant/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/bin/ansible
  python version = 3.9.18 (main, Sep  7 2023, 00:00:00) [GCC 11.4.1 20230605 (Red Hat 11.4.1-2)] (/usr/bin/python3)
  jinja version = 3.1.2
  libyaml = True
</code></pre>
<h1 id="เริมตนการใชงาน-ansible"><a class="header" href="#เริมตนการใชงาน-ansible">เริ่มต้นการใช้งาน Ansible</a></h1>
<p>คำสั่ง ใน Anible มีอยู่ด้วยกัน 2 คำสั่ง คือ <code>ansible</code> และ <code>ansible-playbook</code> มีรูปแบบในการใชงานคำสั่งดังนี้</p>
<p>ansible:</p>
<pre><code>ansible -i &lt;inventory_file&gt; &lt;host patterns&gt; -m &lt;module&gt;
</code></pre>
<p>ansible-playbook:</p>
<pre><code>ansible-playbook -i &lt;inventory_file&gt; &lt;playbook_file&gt; 
</code></pre>
<h2 id="test-connection-ไปยัง-host"><a class="header" href="#test-connection-ไปยัง-host">Test Connection ไปยัง Host</a></h2>
<p>Run คำสั่ง  check connection ด้วย module ชื่อ ping</p>
<pre><code>ansible localhost -m ping
</code></pre>
<p>โดยคำสั่ง <code>ansible localhost -h ping</code> เป็นการใช้ทดสอบ connectivity ไปยัง localhost สามารถแยกคำสั่งได้ดังนี้</p>
<ul>
<li><strong>ansible:</strong> เครื่องมือบรรทัดคำสั่งสำหรับการรันคำสั่ง ad-hoc ด้วย Ansible</li>
<li><strong>localhost:</strong> โฮสต์เป้าหมายสำหรับคำสั่ง Ansible ในกรณีนี้คือเครื่องของเราเอง</li>
<li><strong>-m ping:</strong> ตัวเลือก -m ใช้เพื่อระบุโมดูลที่ต้องการใช้ โดย ping เป็นโมดูลง่ายๆ ของ Ansible ที่ตรวจสอบว่าเป้าหมายสามารถเข้าถึงได้หรือไม่</li>
</ul>
<p>Result</p>
<pre><code>localhost | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p>ซึ่งหมายความว่าโมดูล ping ได้ทำการติดต่อกับ localhost สำเร็จ และได้รับการตอบกลับเป็น "pong" แสดงว่าการเชื่อมต่อนั้นดี หากมีข้อผิดพลาด ข้อความที่แสดงจะช่วยให้คุณสามารถวิเคราะห์ปัญหาได้ครับ</p>
<p>Run คำสั่ง ด้วย <code>module command</code> เพื่อส่งคำสั่งที่เราต้องการ ไปทำงาน ใน server เป้าหมาย</p>
<pre><code>[vagrant@centos9s ~]$ ansible localhost -m command -a "uptime"
localhost | CHANGED | rc=0 &gt;&gt;
 13:51:41 up 33 min,  1 user,  load average: 0.08, 0.05, 0.08
</code></pre>
<p>ผลลัพธ์ที่ได้จากคำสั่งนี้จะเป็นการแสดงระยะเวลาที่เครื่องทำงานมาตั้งแต่การเริ่มต้นเครื่อง</p>
<p><strong>รายละเอียด คำสั่ง:</strong>  <code>ansible localhost -m command -a "uptime"</code> ทำงานดังนี้:</p>
<ul>
<li><strong>ansible:</strong> เครื่องมือบรรทัดคำสั่งสำหรับการรันคำสั่ง ad-hoc ด้วย Ansible</li>
<li><strong>localhost:</strong> โฮสต์เป้าหมายที่คำสั่ง Ansible จะถูกส่งไป ซึ่งในกรณีนี้คือตัวเครื่องของคุณเอง</li>
<li><strong>-m command:</strong> ตัวเลือก <code>-m</code> ใช้เพื่อระบุโมดูลที่ต้องการใช้ ในที่นี้คือโมดูล <code>command</code> ซึ่งใช้สำหรับรันคำสั่งทั่วไป</li>
<li><strong>-a "uptime":</strong> ตัวเลือก <code>-a</code> ใช้เพื่อระบุพารามิเตอร์ของโมดูล ในที่นี้คือคำสั่ง <code>uptime</code> ซึ่งจะแสดงระยะเวลาที่เครื่องทำงานอยู่</li>
</ul>
<h2 id="กำหนดคาของ-host-สำหรับ-ansible"><a class="header" href="#กำหนดคาของ-host-สำหรับ-ansible">กำหนดค่าของ Host สำหรับ Ansible</a></h2>
<p>เพิ่ม  ansible host ใน file <code>/etc/ansible/hosts</code> และต้องใช้สิทธิของผู้ดูแลระบบ เรียก file นี้ว่า Inventory</p>
<pre><code>ls /etc/ansible
sudo vim /etc/ansible/hosts
</code></pre>
<p>content: /etc/ansible/hosts ต่อท้าย ของ file</p>
<pre><code>[servers]
server1 ansible_host=192.168.33.20
</code></pre>
<p>and test ansible add hoc command</p>
<pre><code>ansible -m ping servers
</code></pre>
<p>หรือ <code>[vagrant@centos9s ~]$ ansible servers -i /etc/ansible/hosts -m ping</code>
หรือ <code>[vagrant@centos9s ~]$ ansible server1 -i /etc/ansible/hosts -m ping</code></p>
<p>Errors:</p>
<pre><code>[vagrant@centos9s ~]$ ansible -m ping servers
The authenticity of host '192.168.33.20 (192.168.33.20)' can't be established.
ED25519 key fingerprint is SHA256:0pRyAhg91dyKvyciyc8HBUSDZ8eCkTh60zcecnNZFso.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes

server1 | UNREACHABLE! =&gt; {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: Warning: Permanently added '192.168.33.20' (ED25519) to the list of known hosts.\r\nvagrant@192.168.33.20: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).",
    "unreachable": true
}
</code></pre>
<p>Error ที่เห็น เป็น Error ปรกติ เนื่องจาก ไม่สามารถ authentication ไปยังเครื่องเป้าหมายได้</p>
<h2 id="การกำหนดรูปแบบของการทำ-authentication"><a class="header" href="#การกำหนดรูปแบบของการทำ-authentication">การกำหนดรูปแบบของการทำ Authentication</a></h2>
<p>Ansible ใช้วิธีการหลายวิธีในการทำการ authentication (การตรวจสอบสิทธิ์) กับโฮสต์ที่มันจัดการ ซึ่งวิธีที่ใช้จะขึ้นอยู่กับประเภทของการเชื่อมต่อที่คุณเลือกใช้ นี่คือวิธีการหลัก ๆ ที่ใช้ในการ authentication:</p>
<h3 id="วิธีที-1-การใช-ssh-key-based-authentication"><a class="header" href="#วิธีที-1-การใช-ssh-key-based-authentication">วิธีที่ 1 การใช้ SSH Key-Based Authentication</a></h3>
<p>เป็นวิธีที่นิยมที่สุดในการทำการ authentication ไปยังโฮสต์:</p>
<ul>
<li><strong>การตั้งค่า:</strong>
<ul>
<li>สร้างคู่คีย์ SSH (private และ public) และคัดลอกคีย์ public ไปยังโฟลเดอร์ ~/.ssh/authorized_keys บนโฮสต์เป้าหมาย
การใช้งาน: ในการเชื่อมต่อ Ansible จะใช้คีย์ private ของคุณเพื่อทำการล็อกอินไปยังโฮสต์เป้าหมาย
การกำหนดค่าใน Ansible: โดยทั่วไป Ansible ใช้คีย์ส่วนตัวที่อยู่ใน ~/.ssh/id_rsa หากคุณใช้คีย์ที่ต่างออกไป คุณสามารถกำหนดค่าในไฟล์ ansible.cfg หรือระบุผ่านตัวเลือก --private-key</li>
</ul>
</li>
</ul>
<pre><code>[vagrant@centos9s ~]$ ansible server1 -i /etc/ansible/hosts -m ping
server1 | UNREACHABLE! =&gt; {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: vagrant@192.168.33.20: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).",
    "unreachable": true
}
</code></pre>
<h3 id="วิธีที-2-การใช-password-based-authentication"><a class="header" href="#วิธีที-2-การใช-password-based-authentication">วิธีที่ 2 การใช้ Password-Based Authentication</a></h3>
<p>การใช้รหัสผ่านเป็นอีกทางเลือกหนึ่งในการทำการ authentication แต่ไม่เป็นที่นิยมเท่าการใช้ SSH key เพราะมันอาจจะมีความเสี่ยงด้านความปลอดภัย:</p>
<p>การตั้งค่า: ไม่มีการตั้งค่าเพิ่มเติมที่ต้องทำบนโฮสต์เป้าหมาย แต่คุณต้องระบุรหัสผ่านในคำสั่ง Ansible หรือในไฟล์การกำหนดค่า
การใช้งาน: คุณสามารถระบุรหัสผ่านในคำสั่งหรือไฟล์การกำหนดค่า</p>
<ul>
<li><strong>กำหนด username/password  ใน Cli</strong></li>
</ul>
<pre><code>[vagrant@centos9s ~]$ ansible -m ping servers --user vagrant --ask-pass
SSH password:
server1 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p>Ansible จะรอให้กรอกรหัสของ user vagrant คือ vagrant</p>
<ul>
<li><strong>กำหนดไว้ใน inventory</strong></li>
</ul>
<pre><code>[servers]
server1 ansible_host=192.168.33.20 ansible_ssh_pass=vagrant
</code></pre>
<ul>
<li><strong>encode password ไว้ใน File</strong></li>
</ul>
<pre><code>[vagrant@centos9s ~]$ ansible-vault create secrets.yml
New Vault password:
Confirm New Vault password:
</code></pre>
<p>หลังจากนั้น จะมี Temp file ให้เรากรอกข้อมูล
<img src="../assets/images/ansible-encrypt.png" alt="" /></p>
<p>ให้กด <code>i</code> สำหรับ mode insert และ
เพ่ิ่ม <code>ansible_ssh_pass: password</code>  ใน Temporary file (file ที่ คำสั่ง ansible-vault เตรียมไว้เรานั้น ใช้ Vi เป็น Editor)</p>
<pre><code>ansible_ssh_pass: vagrant
</code></pre>
<p>ทำการบันทึก ด้วยการกด  <code>:wq!</code></p>
<pre><code>cat secrets.yml
</code></pre>
<p><img src="../assets/images/ansible-encrypt-ascii.png" alt="" /></p>
<ul>
<li>content ใน file จะเป็น ascii text</li>
</ul>
<h3 id="ทำการ-decrypt-ยอนกลับ"><a class="header" href="#ทำการ-decrypt-ยอนกลับ">ทำการ Decrypt ย้อนกลับ</a></h3>
<pre><code>[vagrant@centos9s ~]$ ansible-vault decrypt secrets.yml
Vault password:
Decryption successful
[vagrant@centos9s ~]$ cat secrets.yml
ansible_ssh_pass: vagrant
</code></pre>
<h2 id="workshop-สราง-playbookyml"><a class="header" href="#workshop-สราง-playbookyml">Workshop: สร้าง playbook.yml</a></h2>
<h3 id="สราง-inventory-ของ-project-เอง-ชือวา-host-และ-สราง-playbook-สำหรับการทำ-auto"><a class="header" href="#สราง-inventory-ของ-project-เอง-ชือวา-host-และ-สราง-playbook-สำหรับการทำ-auto">สร้าง inventory ของ Project เอง ชื่อว่า host และ สร้าง playbook สำหรับการทำ Auto</a></h3>
<p>สร้าง playbook.yml</p>
<pre><code>---
# playbook.yml

- name: install nginx and start service
  hosts: web
  become: true
  tasks:

   - name: install nginx
     yum: name=nginx state=present

   - name: start service
     service: name=nginx state=restarted
</code></pre>
<p>สร้าง hosts</p>
<pre><code>[web]
192.168.33.20

[web:vars]
ansible_usr=vagrant
</code></pre>
<p>ตรวจสอบ File System ด้วยคำสั่ง <code>ls -l</code> ได้เห็น file ที่สร้าง</p>
<pre><code>[vagrant@centos9s ~]$ ls -l
total 8
-rw-r--r--. 1 vagrant vagrant  19 Aug  1 12:19 hosts
-rw-r--r--. 1 vagrant vagrant 224 Aug  1 12:20 playbook.yml
</code></pre>
<p>Run</p>
<pre><code>[vagrant@centos9s ~]$ ansible web -i host -m ping
192.168.33.20 | UNREACHABLE! =&gt; {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: vagrant@192.168.33.20: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).",
    "unreachable": true
}
</code></pre>
<pre><code>[vagrant@centos9s ~]$ ansible all -i host -m ping
192.168.33.20 | UNREACHABLE! =&gt; {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: vagrant@192.168.33.20: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).",
    "unreachable": true
}
</code></pre>
<p>Run</p>
<pre><code>ansible-playbook -i host playbook.yml
</code></pre>
<p>โดย default แล้ว ansible เลือกใช้วิธี ssh-key authentication แต่ ซื่งจะต้องทำการ Copy ssh-key จากเครื่อง controller ไปยัง เครื่อง servers ที่ระบุใน inventory</p>
<p>วิธีแรก ลองทดสอบ แบบ password authentication ส่วน user จะเป็นชื่อ user บน shell ของเครื่อง controller (user vagrant)</p>
<pre><code>[web]
192.168.33.20  ansible_ssh_pass=vagrant
</code></pre>
<p>ลองทดสอบอีกครั้ง จะพบว่า error เปลี่ยนเป็น Success</p>
<pre><code>[vagrant@centos9s ~]$ ansible all -i host -m ping
192.168.33.20 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p>แต่สำหรับวิธีการใช้ password แบบที่กำหนดค่า password โดยตรงลงไปใน ไฟล์ invetory ทำให้เกิดความเสียงสูง ดังนั้น จะใช้ คำสั่ง <code>ansible-value</code> เพื่อทำการ Encrypt password  โดยใช้คำสั่ง</p>
<pre><code>[vagrant@centos9s ~]$ ansible-vault create secrets.yml
New Vault password:
Confirm New Vault password:
</code></pre>
<p>เพิ่มตัวแปร ไปยัง Temporary File (โดยใช้ VI editor)</p>
<pre><code>ansible_ssh_pass: vagrant
</code></pre>
<p>หลังจากนั้น ansible-vaule จะencrypt password ไปเก็บไว้ใน secrets.yml</p>
<p><img src="../assets/images/secrets_yml.png" alt="" />
ansible_config</p>
<pre><code>[vagrant@centos9s ~]$ ansible all -i host -m ping
192.168.33.20 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p>กลับไปที่วิธี ของ ssh key ต้องสร้าง ssh key ก่อน</p>
<pre><code>ssh-keygen -t rsa
</code></pre>
<pre><code>[vagrant@centos9s ~]$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/vagrant/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/vagrant/.ssh/id_rsa
Your public key has been saved in /home/vagrant/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:toTj+jA2qXwjwVVa3Pt7BS1wpOwHpcZZvZcjVdTRnN8 vagrant@centos9s.localdomain
The key's randomart image is:
+---[RSA 3072]----+
|     . .   .+. +O|
|      + .o.*. .o+|
|     +   .Oo ...+|
|    o  ..o .o.ooE|
| . .  o S.. .o...|
|  o  o + ...  .  |
|   .* . .  . .   |
| ..oo=    . .    |
|  oo.o.    .     |
+----[SHA256]-----+
</code></pre>
<p>copy public key ด้วยคำสั่ง ssh-copy-id ไปยัง server</p>
<pre><code>[vagrant@centos9s ~]$ ssh-copy-id vagrant@192.168.33.20
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/vagrant/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
vagrant@192.168.33.20's password:

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'vagrant@192.168.33.20'"
and check to make sure that only the key(s) you wanted were added.
</code></pre>
<p>อีกขั้นตอน</p>
<pre><code>[web]
192.168.33.20 ansible_ssh_private_key_file=~/.ssh/id_rsa
</code></pre>
<p>คราวนี้ลองทดสอบคำสั่ง อีกครั้ง</p>
<pre><code>[vagrant@centos9s ~]$ ansible all -i host -m ping
192.168.33.20 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p>หรือ ให้ระบุ ใน Ansible config file  (<code>ansible.cfg</code>)</p>
<pre><code>[vagrant@centos9s ~]$ sudo vim /etc/ansible/ansible.cfg
</code></pre>
<pre><code>[defaults]
private_key_file =~/.ssh/id_rsa
</code></pre>
<p>Result</p>
<pre><code>[vagrant@centos9s ~]$ ansible all -i host -m ping
192.168.33.20 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
</code></pre>
<p><img src="../assets/images/ansible_config.png" alt="" /></p>
<pre><code>[vagrant@centos9s ~]$ ansible-playbook -i host playbook.yml
</code></pre>
<p><img src="../assets/images/ansible_nginx.png" alt="" /></p>
<pre><code>[vagrant@centos9s ~]$ ss -tulpn
Netid      State       Recv-Q      Send-Q            Local Address:Port             Peer Address:Port      Process
udp        UNCONN      0           0                     127.0.0.1:323                   0.0.0.0:*
udp        UNCONN      0           0                         [::1]:323                      [::]:*
tcp        LISTEN      0           511                     0.0.0.0:80                    0.0.0.0:*
tcp        LISTEN      0           128                     0.0.0.0:22                    0.0.0.0:*
tcp        LISTEN      0           511                        [::]:80                       [::]:*
tcp        LISTEN      0           128                        [::]:22                       [::]:*
[vagrant@centos9s ~]$
</code></pre>
<pre><code>vagrant halt
vagrant destroy
</code></pre>
<p>แก้ไขfile Vagrantfile</p>
<pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.

$script=&lt;&lt;-SCRIPT
    sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config    
    systemctl restart sshd.service
SCRIPT

Vagrant.configure("2") do |config|
  # The most common configuration options are documented and commented below.
  # For a complete reference, please see the online documentation at
  # https://docs.vagrantup.com.
  config.vm.box = "generic/centos9s"

  config.vm.define "controller" do |control|
    control.vm.hostname = "controller"
    control.vm.network "private_network", ip: "192.168.33.10"
    control.vm.provider "virtualbox" do |vb|
      vb.memory = "1024"
      vb.cpus = 1
    end

    control.vm.provision "shell", inline: &lt;&lt;-SCRIPT
      sudo hostnamectl set-hostname controller
    SCRIPT
  end

  config.vm.define "web" do |web|
    web.vm.hostname = "controller"
    web.vm.network "private_network", ip: "192.168.33.20"
    web.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end
    web.vm.provision "shell", inline: &lt;&lt;-SCRIPT
      sudo hostnamectl set-hostname web
    SCRIPT
  end

  config.vm.define "db" do |db|
    db.vm.hostname = "controller"
    db.vm.network "private_network", ip: "192.168.33.21"
    db.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
    end
    db.vm.provision "shell", inline: &lt;&lt;-SCRIPT
      sudo hostnamectl set-hostname db
    SCRIPT
  end

  config.vm.synced_folder ".", "/vagrant"


  config.vm.provision "shell", inline: $script
end

</code></pre>
<pre><code>vagrant status
vagrant up
</code></pre>
<pre><code>PS C:\Users\sysadmin\VagrantDev\Centos9s&gt; vagrant status
Current machine states:

controller                not created (virtualbox)
web                       not created (virtualbox)
db                        not created (virtualbox)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
</code></pre>
<pre><code>PS C:\Users\sysadmin\VagrantDev\Centos9s&gt; vagrant up
Bringing machine 'controller' up with 'virtualbox' provider...
Bringing machine 'web' up with 'virtualbox' provider...
Bringing machine 'db' up with 'virtualbox' provider...
==&gt; controller: Importing base box 'generic/centos9s'...
Progress: 40%
...
</code></pre>
<p>การเข้าถึง vm ให้ใช้ คำสั่ง vagrant ssh ตามด้วยชื่อ</p>
<pre><code>vagrant ssh controller
vagrant ssh web
vagrant ssh db
</code></pre>
<p>playbook.yml</p>
<pre><code>---
# playbook.yml

- name: install nginx and start service
  hosts: web
  become: true
  tasks:

   - name: install nginx
     yum: name=nginx state=present

   - name: start service
     service: name=nginx state=restarted

- name: install nginx and start service
  hosts: db
  become: true
  tasks:

   - name: install db
     yum: name=mysql state=present

   - name: start service
     service: name=mysql state=restarted
</code></pre>
<p><img src="../assets/images/ansible_multinote1.png" alt="" /></p>
<p><img src="../assets/images/ansible_multinote_ping.png" alt="" /></p>
<pre><code>[vagrant@controller ~]$ ansible-playbook -i hosts playbook.yml -vvv
</code></pre>
<pre><code>---
- name: Install and configure Nginx on web servers
  hosts: web
  become: true
  tasks:
    - name: Install Nginx
      yum:
        name: nginx
        state: present

    - name: Start and enable Nginx service
      service:
        name: nginx
        state: started
        enabled: true

- name: Install and configure MySQL on db servers
  hosts: db
  become: true
  vars:
    mysql_root_password: password
  tasks:
    - name: Install MySQL
      yum:
        name: mysql-server
        state: present

    - name: Start and enable MySQL service
      service:
        name: mysqld
        state: started
        enabled: true

    - name: Set MySQL root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        host: localhost
        state: present

</code></pre>
<pre><code>Key Changes:
Naming: Changed play names to better describe their purposes.
Service Management: Used state: started instead of state: restarted and added enabled: true to ensure the services start on boot.
MySQL Installation: Changed the package name from mysql to mysql-server (commonly used package name for MySQL).
MySQL Service Name: Changed the service name to mysqld (typical name for MySQL service).
MySQL Root Password: Added a task to set the MySQL root password using the mysql_user module.
Feel free to adj
</code></pre>
<p><img src="../assets/images/ansible_nginx_mysql.png" alt="" /></p>
<pre><code>- name: Install and configure MySQL on db servers
  hosts: db
  become: true
  vars:
    mysql_root_password: password
    ansible_python_interpreter: /usr/bin/python3
    sql_file_path: create_tables.sql  # Update this path to your actual SQL file location
  tasks:
    - name: Install MySQL
      yum:
        name: mysql-server
        state: present

    - name: Start and enable MySQL service
      service:
        name: mysqld
        state: started
        enabled: true
        
    - name: Install python
      yum:
        name: python
        state: present

    - name: Install python-pip
      yum:
        name: python-pip
        state: present

    - name: Install PyMySQL Python library
      pip:
        name: PyMySQL
        state: present

    - name: Set MySQL root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        host: localhost
        state: present
      vars:
        ansible_python_interpreter: /usr/bin/python3

    - name: Create tables from SQL file
      mysql_db:
        name: mydatabase
        state: import
        target: "{{ sql_file_path }}"
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_host: localhost
</code></pre>
<pre><code>CREATE DATABASE IF NOT EXISTS mydatabase;
USE mydatabase;

CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    password VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    order_date DATE,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
</code></pre>
<pre><code>- name: Install and configure MySQL on db servers
  hosts: db
  become: true
  vars:
    mysql_root_password: password
    ansible_python_interpreter: /usr/bin/python3
    sql_file_path: create_tables.sql  # Update this path to your actual SQL file location
  tasks:
    - name: Install MySQL
      yum:
        name: mysql-server
        state: present

    - name: Start and enable MySQL service
      service:
        name: mysqld
        state: started
        enabled: true
        
    - name: Install python
      yum:
        name: python
        state: present

    - name: Install python-pip
      yum:
        name: python-pip
        state: present

    - name: Install PyMySQL Python library
      pip:
        name: PyMySQL
        state: present

    - name: Set MySQL root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        host: localhost
        state: present
      vars:
        ansible_python_interpreter: /usr/bin/python3

    - name: Create tables from SQL file
      mysql_db:
        name: mydatabase
        state: import
        target: "{{ sql_file_path }}"
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_host: localhost
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../module1/yaml_basic.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../module1/yaml_basic.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src=".././src/js/highlightjs-line-numbers.js"></script>


    </div>
    </body>
</html>
